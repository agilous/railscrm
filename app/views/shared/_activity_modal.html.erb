<!-- Activity Scheduling Modal -->
<div id="activityModal"
     class="hidden fixed z-50 inset-0 overflow-y-auto"
     data-controller="activity-modal"
     data-activity-modal-target="modal"
     role="dialog"
     aria-modal="true"
     aria-labelledby="modal-title">
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500/75 transition-opacity" data-action="click->activity-modal#close" aria-label="Close modal"></div>

    <!-- This span helps vertically center the modal -->
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

    <!-- Modal panel -->
    <div class="relative inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full z-10">
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4 max-h-[70vh] overflow-y-auto">
        <div class="sm:flex sm:items-start">
          <div class="mx-auto shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
          </div>
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
              Schedule Activity
            </h3>

            <%= form_with(model: [@contact, Activity.new], id: "activity-form", class: "mt-4", local: true, data: { activity_modal_target: "form", action: "submit->activity-modal#submit" }) do |f| %>
              <!-- Activity Type -->
              <div class="mb-4">
                <%= f.label :activity_type, class: "block text-sm font-medium text-gray-700" do %>
                  Activity Type <span class="text-red-500">*</span>
                <% end %>
                <%= f.select :activity_type, options_for_select(Activity::ACTIVITY_TYPES),
                    { prompt: "Select activity type" },
                    { class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500", required: true } %>
              </div>

              <!-- Title -->
              <div class="mb-4">
                <%= f.label :title, class: "block text-sm font-medium text-gray-700" do %>
                  Title <span class="text-red-500">*</span>
                <% end %>
                <%= f.text_field :title,
                    class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500",
                    placeholder: "e.g., Follow-up call about product demo",
                    required: true %>
              </div>

              <!-- Description -->
              <div class="mb-4">
                <%= f.label :description, "Description", class: "block text-sm font-medium text-gray-700" %>
                <%= f.text_area :description,
                    rows: 3,
                    class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500",
                    placeholder: "Add notes or details about this activity..." %>
              </div>

              <!-- Due Date and Time -->
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div data-controller="datetime-picker">
                  <%= f.label :due_date, class: "block text-sm font-medium text-gray-700" do %>
                    Due Date & Time
                    <span class="text-xs text-gray-500" data-datetime-picker-target="timezone"></span>
                  <% end %>
                  <%= f.text_field :due_date,
                      value: nil,
                      class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500",
                      data: { datetime_picker_target: "input" },
                      placeholder: "Select date and time" %>
                  <%= hidden_field_tag :user_timezone, nil, id: "user_timezone" %>
                </div>

                <div>
                  <%= f.label :duration, "Duration (minutes)", class: "block text-sm font-medium text-gray-700" %>
                  <%= f.number_field :duration,
                      value: 30,
                      min: 5,
                      step: 5,
                      class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500",
                      placeholder: "30" %>
              </div>

              <!-- Priority -->
              <div class="mb-4">
                <%= f.label :priority, "Priority", class: "block text-sm font-medium text-gray-700" %>
                <%= f.select :priority, options_for_select(Activity::PRIORITY_LEVELS),
                    { prompt: "Select priority" },
                    { class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500" } %>
              </div>

              <!-- Assignee -->
              <% if @users&.any? %>
                <div class="mb-4">
                  <%= f.label :user_id, "Assign To", class: "block text-sm font-medium text-gray-700" %>
                  <%= f.collection_select :user_id, @users, :id, :full_name,
                      { prompt: "Assign to user (optional)" },
                      { class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500" } %>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>

      <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button
          type="button"
          data-action="click->activity-modal#submit"
          class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
          Schedule Activity
        </button>
        <button
          type="button"
          data-action="click->activity-modal#close"
          class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Set user timezone on page load
  document.addEventListener('DOMContentLoaded', function() {
    const timezoneField = document.getElementById('user_timezone');
    if (timezoneField) {
      timezoneField.value = Intl.DateTimeFormat().resolvedOptions().timeZone;
    }
  });
</script>
