#!/usr/bin/env ruby

def pass_fail(passed, message)
  puts "#{message}: #{passed ? "\e[32m\u2713\e[0m" : "\e[31m\u2717\e[0m" }\n"
end

def terminal_message(text)
  puts "\e[1m\e[96m#{text}\e[0m"
end

APP_ROOT = File.expand_path('..', __dir__)
Dir.chdir(APP_ROOT) do
  terminal_message("Installing JavaScript dependencies...")
  system("npm install --silent")
  terminal_message("Done.\n\n")

  terminal_message("Building Tailwind CSS...")
  system("bundle exec rails tailwindcss:build")
  terminal_message("Done.\n\n")

  terminal_message("Running Ruby Tests...")
  ruby_tests_passed = system("bundle exec rspec --format progress 2>/dev/null")
  terminal_message("Done.\n\n")

  terminal_message("Running JavaScript Tests...")
  js_tests_passed = system("NODE_OPTIONS='--no-deprecation' npm test -- --silent --no-watchman --forceExit 2>/dev/null")
  terminal_message("Done.\n\n")

  terminal_message("Linting Ruby Code...")
  ruby_linting_passed = system("bundle exec rubocop --parallel")
  terminal_message("Done.\n\n")

  terminal_message("Linting JavaScript Code...")
  js_linting_passed = system("npm run lint -- --quiet 2>/dev/null")
  terminal_message("Done.\n\n")

  terminal_message("Vulnerability Scanning...")
  vulnerability_scan_passed = system('bundle exec brakeman --no-pager')
  terminal_message("Done.\n\n")

  pass_fail(ruby_tests_passed, "Ruby Tests")
  pass_fail(js_tests_passed, "JavaScript Tests")
  pass_fail(ruby_linting_passed, "Ruby Linter")
  pass_fail(js_linting_passed, "JavaScript Linter")
  pass_fail(vulnerability_scan_passed, "Vulnerability Scan")

  if ruby_tests_passed && js_tests_passed && ruby_linting_passed && js_linting_passed && vulnerability_scan_passed
    exit 0
  else
    exit 1
  end
end
